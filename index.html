<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <!-- Chart.js –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; height: 100vh; display: flex; flex-direction: column; }
        
        #controls {
            background: #2c3e50;
            color: white;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .control-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .control-row:last-child { margin-bottom: 0; }
        
        label {
            min-width: 100px;
            font-weight: bold;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            padding: 8px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        
        button:hover { background: #2980b9; }
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        #mainContainer {
            flex: 1;
            display: flex;
            position: relative;
        }
        
        #map {
            flex: 1;
            position: relative;
        }
        
        #sidebar {
            width: 350px;
            background: #34495e;
            color: white;
            padding: 15px;
            overflow-y: auto;
            box-shadow: -2px 0 5px rgba(0,0,0,0.3);
        }
        
        .sidebar-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #2c3e50;
            border-radius: 8px;
        }
        
        .sidebar-section h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #3498db;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 14px;
        }
        
        .metric-label {
            color: #bdc3c7;
        }
        
        .metric-value {
            font-weight: bold;
            color: #ecf0f1;
            font-size: 16px;
        }
        
        .chart-container {
            position: relative;
            height: 150px;
            margin-top: 10px;
        }
        
        .control-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .control-buttons button {
            flex: 1;
            padding: 10px;
            font-size: 14px;
        }
        
        #playBtn {
            background: #27ae60;
        }
        
        #playBtn:hover {
            background: #229954;
        }
        
        #pauseBtn {
            background: #e67e22;
        }
        
        #pauseBtn:hover {
            background: #d35400;
        }
        
        #resetBtn {
            background: #e74c3c;
        }
        
        #resetBtn:hover {
            background: #c0392b;
        }
        
        #status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px 15px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 300px;
            font-size: 13px;
        }
        
        .status-loading { color: #f39c12; }
        .status-success { color: #27ae60; }
        .status-error { color: #e74c3c; }
        
        #info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 1000;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="controls">
        <div class="control-row">
            <label>–û—Ç–∫—É–¥–∞:</label>
            <input type="text" id="startAddress" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, –ù–µ–≤—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç">
            <button onclick="geocodeStart()">–ù–∞–π—Ç–∏</button>
        </div>
        <div class="control-row">
            <label>–ö—É–¥–∞:</label>
            <input type="text" id="endAddress" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞, –ö—Ä–∞—Å–Ω–∞—è –ø–ª–æ—â–∞–¥—å">
            <button onclick="geocodeEnd()">–ù–∞–π—Ç–∏</button>
        </div>
        <div class="control-row">
            <label>–¢–æ—á–µ–∫:</label>
            <input type="text" id="nPoints" value="100000" style="flex: 0 0 120px;">
            <button onclick="buildRoute()" id="buildBtn">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
            <div id="routeInfo" style="margin-left: 20px; display: none; color: #ecf0f1; font-size: 14px;">
                <span style="margin-right: 15px;">üìè –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: <strong id="routeDistance">-</strong></span>
                <span style="margin-right: 15px;">‚õΩ –†–∞—Å—Ö–æ–¥: <strong id="fuelConsumption">-</strong></span>
                <span>üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: <strong id="fuelCost">-</strong></span>
            </div>
        </div>
    </div>
    
    <div id="mainContainer">
        <div id="map">
            <div id="status"></div>
            <div id="info">
                Zoom: <span id="zoomLevel">6</span><br>
                –¢–æ—á–µ–∫ –Ω–∞ –∫–∞—Ä—Ç–µ: <span id="pointsCount">0</span>
            </div>
        </div>
        
        <div id="sidebar">
            <div class="sidebar-section">
                <h3>üöó –¢–µ–∫—É—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h3>
                <div class="metric">
                    <span class="metric-label">–°–∫–æ—Ä–æ—Å—Ç—å:</span>
                    <span class="metric-value" id="currentSpeed">0 –∫–º/—á</span>
                </div>
                <div class="metric">
                    <span class="metric-label">–í—Ä–µ–º—è –≤ –ø—É—Ç–∏:</span>
                    <span class="metric-value" id="travelTime">0:00</span>
                </div>
                <div class="metric">
                    <span class="metric-label">–ü—Ä–æ–π–¥–µ–Ω–æ:</span>
                    <span class="metric-value" id="distanceTraveled">0.0 –∫–º</span>
                </div>
                <div class="metric">
                    <span class="metric-label">–¢–µ–∫—É—â–∏–π —Ä–∞—Å—Ö–æ–¥:</span>
                    <span class="metric-value" id="currentConsumption">0.0 –ª/100–∫–º</span>
                </div>
                <div class="control-buttons">
                    <button id="playBtn" onclick="startSimulation()">‚ñ∂ –°—Ç–∞—Ä—Ç</button>
                    <button id="pauseBtn" onclick="pauseSimulation()">‚è∏ –ü–∞—É–∑–∞</button>
                    <button id="resetBtn" onclick="resetSimulation()">‚èπ –°–±—Ä–æ—Å</button>
                </div>
                <div class="metric" style="margin-top: 15px;">
                    <span class="metric-label">–°–∫–æ—Ä–æ—Å—Ç—å —Å–∏–º—É–ª—è—Ü–∏–∏:</span>
                    <span class="metric-value" id="speedMultiplierValue">1x</span>
                </div>
                <input type="range" id="speedMultiplier" min="1" max="100" value="1" 
                       style="width: 100%; margin-top: 5px;" 
                       oninput="updateSpeedMultiplier(this.value)">
                <div style="display: flex; justify-content: space-between; font-size: 11px; color: #95a5a6; margin-top: 2px;">
                    <span>1x (—Ä–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è)</span>
                    <span>100x</span>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3>üìä –ü—Ä–æ—Ñ–∏–ª—å –≤—ã—Å–æ—Ç</h3>
                <div class="chart-container">
                    <canvas id="elevationChart"></canvas>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3>üìà –£–∫–ª–æ–Ω –¥–æ—Ä–æ–≥–∏</h3>
                <div class="chart-container">
                    <canvas id="gradientChart"></canvas>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3>üöÄ –°–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è</h3>
                <div class="chart-container">
                    <canvas id="speedChart"></canvas>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3>‚ö° –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å</h3>
                <div class="metric">
                    <span class="metric-label">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è:</span>
                    <span class="metric-value" id="optimalSpeed">- –∫–º/—á</span>
                </div>
                <div class="metric">
                    <span class="metric-label">–ü—Ä–∏—á–∏–Ω–∞:</span>
                    <span class="metric-value" id="speedReason" style="font-size: 12px;">-</span>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3>üöõ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¢–°</h3>
                <div class="metric">
                    <span class="metric-label">–ú–∞—Å—Å–∞ –¢–°:</span>
                    <span class="metric-value" id="vehicleMass">- –∫–≥</span>
                </div>
                <div class="metric">
                    <span class="metric-label">–ú–∞—Å—Å–∞ –≥—Ä—É–∑–∞:</span>
                    <span class="metric-value" id="cargoMass">- –∫–≥</span>
                </div>
                <div class="metric">
                    <span class="metric-label">–û–±—â–∞—è –º–∞—Å—Å–∞:</span>
                    <span class="metric-value" id="totalMass">- –∫–≥</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        const map = L.map('map').setView([57.5, 34], 6);
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–π–ª—ã OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let startCoords = null;
        let endCoords = null;
        let startMarker = null;
        let endMarker = null;
        let routeLayers = {
            full: null,
            high: null,
            medium: null,
            low: null
        };
        let currentLevel = 'low';
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è
        let vehicleData = null;
        let routePoints = [];
        let currentPointIndex = 0;
        let vehicleMarker = null;
        let traveledPath = null;
        let simulationInterval = null;
        let isSimulationRunning = false;
        let simulationStartTime = null;
        let totalSimulationTime = 0;
        let pausedTime = 0;
        let currentSpeed = 0;
        let timeMultiplier = 1.0;
        let totalDistanceKm = 0;
        
        // –ì—Ä–∞—Ñ–∏–∫–∏
        let elevationChart = null;
        let gradientChart = null;
        let speedChart = null;
        let speedHistory = [];
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑—É–º–µ
        map.on('zoomend', function() {
            document.getElementById('zoomLevel').textContent = map.getZoom();
            updateRouteVisibility();
        });
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = type === 'loading' ? 'status-loading' : 
                                 type === 'success' ? 'status-success' : 
                                 type === 'error' ? 'status-error' : '';
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusDiv.textContent = '';
                    statusDiv.className = '';
                }, 5000);
            }
        }
        
        // –ì–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–∏
        async function geocodeStart() {
            const address = document.getElementById('startAddress').value.trim();
            if (!address) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å');
                return;
            }
            
            showStatus('–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞...', 'loading');
            
            try {
                const response = await fetch('http://localhost:8001/geocode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    startCoords = { lat: data.lat, lon: data.lon };
                    

                    if (startMarker) map.removeLayer(startMarker);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
                    startMarker = L.marker([data.lat, data.lon], {
                        title: '–ù–∞—á–∞–ª–æ',
                        draggable: true  // –ú–∞—Ä–∫–µ—Ä –º–æ–∂–Ω–æ –ø–µ—Ä–µ–º–µ—â–∞—Ç—å!
                    }).addTo(map);
                    startMarker.bindPopup(`<b>–ù–∞—á–∞–ª–æ:</b><br>${address}`).openPopup();
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞
                    startMarker.on('dragend', function(e) {
                        const newPos = e.target.getLatLng();
                        startCoords = { lat: newPos.lat, lon: newPos.lng };
                        showStatus(`–ù–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞: ${newPos.lat.toFixed(4)}, ${newPos.lng.toFixed(4)}`, 'success');
                        // –û–±–Ω–æ–≤–ª—è–µ–º popup —Å –Ω–æ–≤—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
                        startMarker.setPopupContent(`<b>–ù–∞—á–∞–ª–æ:</b><br>Lat: ${newPos.lat.toFixed(4)}<br>Lon: ${newPos.lng.toFixed(4)}`);
                    });
                    
                    map.setView([data.lat, data.lon], 12);
                    showStatus('–ù–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ –Ω–∞–π–¥–µ–Ω–∞ (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–º–µ—â–∞—Ç—å)', 'success');
                } else {
                    showStatus(data.error || '–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞', 'error');
                }
            } catch (error) {
                showStatus('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                console.error(error);
            }
        }
        
        // –ì–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω–µ—á–Ω–æ–π —Ç–æ—á–∫–∏
        async function geocodeEnd() {
            const address = document.getElementById('endAddress').value.trim();
            if (!address) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å');
                return;
            }
            
            showStatus('–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞...', 'loading');
            
            try {
                const response = await fetch('http://localhost:8001/geocode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    endCoords = { lat: data.lat, lon: data.lon };
                    
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –º–∞—Ä–∫–µ—Ä
                    if (endMarker) map.removeLayer(endMarker);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
                    endMarker = L.marker([data.lat, data.lon], {
                        title: '–ö–æ–Ω–µ—Ü',
                        draggable: true  // –ú–∞—Ä–∫–µ—Ä –º–æ–∂–Ω–æ –ø–µ—Ä–µ–º–µ—â–∞—Ç—å!
                    }).addTo(map);
                    endMarker.bindPopup(`<b>–ö–æ–Ω–µ—Ü:</b><br>${address}`).openPopup();
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞
                    endMarker.on('dragend', function(e) {
                        const newPos = e.target.getLatLng();
                        endCoords = { lat: newPos.lat, lon: newPos.lng };
                        showStatus(`–ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞: ${newPos.lat.toFixed(4)}, ${newPos.lng.toFixed(4)}`, 'success');
                        // –û–±–Ω–æ–≤–ª—è–µ–º popup —Å –Ω–æ–≤—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
                        endMarker.setPopupContent(`<b>–ö–æ–Ω–µ—Ü:</b><br>Lat: ${newPos.lat.toFixed(4)}<br>Lon: ${newPos.lng.toFixed(4)}`);
                    });
                    
                    map.setView([data.lat, data.lon], 12);
                    showStatus('–ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞ –Ω–∞–π–¥–µ–Ω–∞ (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–º–µ—â–∞—Ç—å)', 'success');
                } else {
                    showStatus(data.error || '–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞', 'error');
                }
            } catch (error) {
                showStatus('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                console.error(error);
            }
        }
        
        // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞
        async function buildRoute() {
            if (!startCoords || !endCoords) {
                alert('–°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é –∏ –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫–∏');
                return;
            }
            
            const nPoints = parseInt(document.getElementById('nPoints').value);
            if (isNaN(nPoints) || nPoints < 100 || nPoints > 1000000) {
                alert('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 100 –¥–æ 1000000');
                return;
            }
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            const buildBtn = document.getElementById('buildBtn');
            buildBtn.disabled = true;
            buildBtn.textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';
            
            showStatus('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∞... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç', 'loading');
            
            try {
                const response = await fetch('http://localhost:8001/build_route', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        start_lat: startCoords.lat,
                        start_lon: startCoords.lon,
                        end_lat: endCoords.lat,
                        end_lon: endCoords.lon,
                        n_points: nPoints
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showStatus(`–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω! –í—Å–µ–≥–æ —Ç–æ—á–µ–∫: ${data.total_points}`, 'success');
                    
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–ª–æ–∏
                    Object.values(routeLayers).forEach(layer => {
                        if (layer) map.removeLayer(layer);
                    });
                    
                    // –°–æ–∑–¥–∞–µ–º —Å–ª–æ–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞–∑–Ω—ã–µ —Ü–≤–µ—Ç–∞ –∏ —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
                    const styles = {
                        full: { color: 'red', radius: 2, weight: 1 },
                        high: { color: 'orange', radius: 3, weight: 1 },
                        medium: { color: 'blue', radius: 4, weight: 2 },
                        low: { color: 'green', radius: 5, weight: 2 }
                    };
                    
                    Object.keys(data.levels).forEach(levelName => {
                        const geojson = data.levels[levelName];
                        const style = styles[levelName];
                        
                        routeLayers[levelName] = L.geoJSON(geojson, {
                            pointToLayer: function(feature, latlng) {
                                return L.circleMarker(latlng, {
                                    radius: style.radius,
                                    fillColor: style.color,
                                    color: style.color,
                                    weight: style.weight,
                                    opacity: 0.6,
                                    fillOpacity: 0.4
                                });
                            },
                            onEachFeature: function(feature, layer) {
                                // –î–æ–±–∞–≤–ª—è–µ–º popup —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–æ—á–∫–µ
                                const props = feature.properties;
                                layer.bindPopup(`
                                    <b>–¢–æ—á–∫–∞ ${props.idx}</b><br>
                                    –í—ã—Å–æ—Ç–∞: ${props.elevation ? props.elevation.toFixed(1) + ' –º' : '–Ω/–¥'}<br>
                                    –ì—Ä–∞–¥–∏–µ–Ω—Ç: ${props.gradient ? props.gradient.toFixed(2) + '%' : '–Ω/–¥'}
                                `);
                            }
                        });
                    });
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
                    updateRouteVisibility();
                    
                    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–µ
                    if (routeLayers.low) {
                        map.fitBounds(routeLayers.low.getBounds());
                    }
                    
                    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞—Ä—à—Ä—É—Ç–µ
                    calculateRouteInfo(data);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ—á–∫–∏ –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏
                    routePoints = data.levels.full.features.map(f => ({
                        lat: f.geometry.coordinates[1],
                        lon: f.geometry.coordinates[0],
                        elevation: f.properties.elevation,
                        gradient: f.properties.gradient,
                        dist_m: f.properties.idx * (data.total_distance / data.total_points)
                    }));
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
                    updateChartsWithRoute(data);
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–∏–º—É–ª—è—Ü–∏—é
                    resetSimulation();
                    
                    showStatus('–ú–∞—Ä—à—Ä—É—Ç –≥–æ—Ç–æ–≤! –ù–∞–∂–º–∏—Ç–µ "–°—Ç–∞—Ä—Ç" –¥–ª—è –Ω–∞—á–∞–ª–∞ —Å–∏–º—É–ª—è—Ü–∏–∏', 'success');
                    
                } else {
                    showStatus(data.error || '–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞', 'error');
                }
                
            } catch (error) {
                showStatus('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                console.error(error);
            } finally {
                buildBtn.disabled = false;
                buildBtn.textContent = '–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç';
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å–ª–æ–µ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑—É–º–∞
        // –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è: –Ω–∞ –Ω–∏–∑–∫–∏—Ö –∑—É–º–∞—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—å—à–µ —Ç–æ—á–µ–∫
        function updateRouteVisibility() {
            const zoom = map.getZoom();
            let newLevel;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ –∑—É–º—É
            if (zoom <= 8) {
                newLevel = 'low';  // –ö–∞–∂–¥–∞—è 1000-—è —Ç–æ—á–∫–∞
            } else if (zoom <= 11) {
                newLevel = 'medium';  // –ö–∞–∂–¥–∞—è 100-—è —Ç–æ—á–∫–∞
            } else if (zoom <= 14) {
                newLevel = 'high';  // –ö–∞–∂–¥–∞—è 10-—è —Ç–æ—á–∫–∞
            } else {
                newLevel = 'full';  // –í—Å–µ —Ç–æ—á–∫–∏
            }
            
            // –ï—Å–ª–∏ —É—Ä–æ–≤–µ–Ω—å –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
            if (newLevel === currentLevel) return;
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–ª–æ–π
            if (routeLayers[currentLevel]) {
                map.removeLayer(routeLayers[currentLevel]);
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤—ã–π —Å–ª–æ–π
            if (routeLayers[newLevel]) {
                routeLayers[newLevel].addTo(map);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Ç–æ—á–µ–∫
                const pointsCount = routeLayers[newLevel].getLayers().length;
                document.getElementById('pointsCount').textContent = pointsCount;
            }
            
            currentLevel = newLevel;
        }
        

        function calculateRouteInfo(data) {

            const fullLevel = data.levels.full;
            if (!fullLevel || !fullLevel.features || fullLevel.features.length === 0) {
                return;
            }
            

            let maxDistance = 0;
            fullLevel.features.forEach(feature => {
            });
            

            const totalDistance = data.total_distance || calculateDistanceFromPoints(fullLevel.features);
            
            // –í –∫–º
            const distanceKm = totalDistance / 1000;
            

            const fuelConsumptionPer100km = 8.0;
            const fuelLiters = (distanceKm / 100) * fuelConsumptionPer100km;
            
            // –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –±–µ–Ω–∑–∏–Ω–∞ 95
            const fuelPricePerLiter = 67;
            const fuelCostRub = fuelLiters * fuelPricePerLiter;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.getElementById('routeDistance').textContent = 
                `${distanceKm.toFixed(1)} –∫–º`;
            
            document.getElementById('fuelConsumption').textContent = 
                `${fuelLiters.toFixed(1)} –ª (${fuelConsumptionPer100km} –ª/100–∫–º)`;
            
            document.getElementById('fuelCost').textContent = 
                `${fuelCostRub.toFixed(0)} ‚ÇΩ (${fuelPricePerLiter} ‚ÇΩ/–ª)`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
            document.getElementById('routeInfo').style.display = 'flex';
            document.getElementById('routeInfo').style.alignItems = 'center';
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: —Ä–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –ø–æ —Ç–æ—á–∫–∞–º
        function calculateDistanceFromPoints(features) {
            if (features.length < 2) return 0;
            
            let totalDistance = 0;
            
            for (let i = 1; i < features.length; i++) {
                const prev = features[i - 1].geometry.coordinates;
                const curr = features[i].geometry.coordinates;
                
                // –§–æ—Ä–º—É–ª–∞ –≥–∞–≤–µ—Ä—Å–∏–Ω—É—Å–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
                const R = 6371000; // –†–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –º–µ—Ç—Ä–∞—Ö
                const lat1 = prev[1] * Math.PI / 180;
                const lat2 = curr[1] * Math.PI / 180;
                const dLat = (curr[1] - prev[1]) * Math.PI / 180;
                const dLon = (curr[0] - prev[0]) * Math.PI / 180;
                
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                         Math.cos(lat1) * Math.cos(lat2) *
                         Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                
                totalDistance += R * c;
            }
            
            return totalDistance;
        }
        
        // ========== –°–ò–ú–£–õ–Ø–¶–ò–Ø –î–í–ò–ñ–ï–ù–ò–Ø ==========
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¢–°
        async function loadVehicleData() {
            try {
                const response = await fetch('/vehicle_data.json');
                if (!response.ok) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å vehicle_data.json');
                }
                vehicleData = await response.json();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –¢–°
                document.getElementById('vehicleMass').textContent = 
                    vehicleData.vehicle.vehicle_mass_kg.toLocaleString() + ' –∫–≥';
                document.getElementById('cargoMass').textContent = 
                    vehicleData.vehicle.cargo_mass_kg.toLocaleString() + ' –∫–≥';
                document.getElementById('totalMass').textContent = 
                    vehicleData.vehicle.total_mass_kg.toLocaleString() + ' –∫–≥';
                
                timeMultiplier = vehicleData.simulation.time_multiplier || 1.0;
                document.getElementById('speedMultiplier').value = timeMultiplier;
                document.getElementById('speedMultiplierValue').textContent = timeMultiplier + 'x';
                    
                console.log('–î–∞–Ω–Ω—ã–µ –¢–° –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', vehicleData);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¢–°:', error);
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                document.getElementById('vehicleMass').textContent = '3500 –∫–≥';
                document.getElementById('cargoMass').textContent = '2000 –∫–≥';
                document.getElementById('totalMass').textContent = '5500 –∫–≥';
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–Ω–æ–∂–∏—Ç–µ–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
        function updateSpeedMultiplier(value) {
            timeMultiplier = parseFloat(value);
            document.getElementById('speedMultiplierValue').textContent = timeMultiplier + 'x';
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
        function initCharts() {
            // –ì—Ä–∞—Ñ–∏–∫ –≤—ã—Å–æ—Ç
            const elevationCtx = document.getElementById('elevationChart').getContext('2d');
            elevationChart = new Chart(elevationCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '–í—ã—Å–æ—Ç–∞ (–º)',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { display: false },
                        y: {
                            ticks: { color: '#ecf0f1', font: { size: 10 } },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
            
            // –ì—Ä–∞—Ñ–∏–∫ —É–∫–ª–æ–Ω–∞
            const gradientCtx = document.getElementById('gradientChart').getContext('2d');
            gradientChart = new Chart(gradientCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '–£–∫–ª–æ–Ω (%)',
                        data: [],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { display: false },
                        y: {
                            ticks: { color: '#ecf0f1', font: { size: 10 } },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
            
            // –ì—Ä–∞—Ñ–∏–∫ —Å–∫–æ—Ä–æ—Å—Ç–∏
            const speedCtx = document.getElementById('speedChart').getContext('2d');
            speedChart = new Chart(speedCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '–°–∫–æ—Ä–æ—Å—Ç—å (–∫–º/—á)',
                        data: [],
                        borderColor: '#2ecc71',
                        backgroundColor: 'rgba(46, 204, 113, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { display: false },
                        y: {
                            min: 0,
                            max: 100,
                            ticks: { color: '#ecf0f1', font: { size: 10 } },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å –¥–∞–Ω–Ω—ã–º–∏ –º–∞—Ä—à—Ä—É—Ç–∞
        function updateChartsWithRoute(data) {
            if (!data.levels || !data.levels.medium) return;
            
            const points = data.levels.medium.features;
            const elevations = [];
            const gradients = [];
            const labels = [];
            
            points.forEach((feature, idx) => {
                if (idx % 10 === 0) { // –ö–∞–∂–¥–∞—è 10-—è —Ç–æ—á–∫–∞ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                    labels.push('');
                    elevations.push(feature.properties.elevation || 0);
                    gradients.push(feature.properties.gradient || 0);
                }
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ dataset (–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç—ã–µ)
            elevationChart.data.labels = labels;
            elevationChart.data.datasets[0].data = []; // –ù–∞—á–∏–Ω–∞–µ–º —Å –ø—É—Å—Ç–æ–≥–æ
            elevationChart.data.datasets[0].fullData = elevations; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            elevationChart.update('none');
            
            gradientChart.data.labels = labels;
            gradientChart.data.datasets[0].data = []; // –ù–∞—á–∏–Ω–∞–µ–º —Å –ø—É—Å—Ç–æ–≥–æ
            gradientChart.data.datasets[0].fullData = gradients; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            gradientChart.update('none');
        }
        
        // –†–∞—Å—á–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏
        function calculateOptimalSpeed(gradient, currentSpeed) {
            if (!vehicleData) return { speed: 60, reason: '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...' };
            
            const maxSpeed = vehicleData.vehicle.max_speed_kmh;
            let optimalSpeed = maxSpeed;
            let reason = '–ù–æ—Ä–º–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è';
            
            // –£—á–∏—Ç—ã–≤–∞–µ–º —É–∫–ª–æ–Ω
            if (gradient > 5) {
                optimalSpeed = Math.max(30, maxSpeed - (gradient - 5) * 5);
                reason = `–ö—Ä—É—Ç–æ–π –ø–æ–¥—ä–µ–º ${gradient.toFixed(1)}%`;
            } else if (gradient < -5) {
                optimalSpeed = Math.max(40, maxSpeed - Math.abs(gradient + 5) * 3);
                reason = `–ö—Ä—É—Ç–æ–π —Å–ø—É—Å–∫ ${gradient.toFixed(1)}%`;
            } else if (gradient > 2) {
                optimalSpeed = maxSpeed * 0.8;
                reason = `–ü–æ–¥—ä–µ–º ${gradient.toFixed(1)}%`;
            } else if (gradient < -2) {
                optimalSpeed = maxSpeed * 0.85;
                reason = `–°–ø—É—Å–∫ ${gradient.toFixed(1)}%`;
            }
            
            return { speed: Math.round(optimalSpeed), reason: reason };
        }
        
        // –†–∞—Å—á–µ—Ç —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞—Å—Ö–æ–¥–∞ —Ç–æ–ø–ª–∏–≤–∞
        function calculateCurrentConsumption(speed, gradient) {
            if (!vehicleData) {
                console.warn('vehicleData –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
                return 12.0; // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            }
            
            if (speed === 0) return 0;
            
            const baseConsumption = vehicleData.vehicle.fuel_consumption_base_l_per_100km || 12.0;
            
            // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –≤–ª–∏—è–Ω–∏—è
            const speedFactor = 1 + (speed - 60) * 0.01; // –û–ø—Ç–∏–º—É–º –Ω–∞ 60 –∫–º/—á
            const gradientFactor = 1 + gradient * 0.05; // 5% –Ω–∞ –∫–∞–∂–¥—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç —É–∫–ª–æ–Ω–∞
            
            const consumption = baseConsumption * speedFactor * gradientFactor;
            
            console.log('–†–∞—Å—Ö–æ–¥:', {
                speed,
                gradient,
                baseConsumption,
                speedFactor: speedFactor.toFixed(2),
                gradientFactor: gradientFactor.toFixed(2),
                consumption: consumption.toFixed(2)
            });
            
            return Math.max(0, consumption);
        }
        
        // –°—Ç–∞—Ä—Ç —Å–∏–º—É–ª—è—Ü–∏–∏
        function startSimulation() {
            if (!routePoints || routePoints.length === 0) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ—Å—Ç—Ä–æ–π—Ç–µ –º–∞—Ä—à—Ä—É—Ç!');
                return;
            }
            
            if (isSimulationRunning) return;
            
            isSimulationRunning = true;
            simulationStartTime = Date.now() - pausedTime;
            
            // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä –¢–° –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            if (!vehicleMarker) {
                const startPoint = routePoints[currentPointIndex];
                vehicleMarker = L.marker([startPoint.lat, startPoint.lon], {
                    icon: L.divIcon({
                        className: 'vehicle-marker',
                        html: '<div style="background: #e74c3c; width: 12px; height: 12px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>',
                        iconSize: [18, 18],
                        iconAnchor: [9, 9]
                    })
                }).addTo(map);
                
                // –°–æ–∑–¥–∞–µ–º –ª–∏–Ω–∏—é –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–≥–æ –ø—É—Ç–∏
                traveledPath = L.polyline([], {
                    color: '#27ae60',
                    weight: 4,
                    opacity: 0.7
                }).addTo(map);
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
            simulationInterval = setInterval(updateSimulation, vehicleData?.simulation.update_interval_ms || 100);
            
            document.getElementById('playBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
        }
        
        // –ü–∞—É–∑–∞ —Å–∏–º—É–ª—è—Ü–∏–∏
        function pauseSimulation() {
            if (!isSimulationRunning) return;
            
            isSimulationRunning = false;
            pausedTime = Date.now() - simulationStartTime;
            
            if (simulationInterval) {
                clearInterval(simulationInterval);
                simulationInterval = null;
            }
            
            document.getElementById('playBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
        }
        
        // –°–±—Ä–æ—Å —Å–∏–º—É–ª—è—Ü–∏–∏
        function resetSimulation() {
            pauseSimulation();
            
            currentPointIndex = 0;
            totalSimulationTime = 0;
            pausedTime = 0;
            simulationStartTime = null;
            currentSpeed = 0;
            speedHistory = [];
            
            if (vehicleMarker) {
                map.removeLayer(vehicleMarker);
                vehicleMarker = null;
            }
            
            if (traveledPath) {
                map.removeLayer(traveledPath);
                traveledPath = null;
            }
            
            // –°–±—Ä–æ—Å –≥—Ä–∞—Ñ–∏–∫–æ–≤
            if (speedChart) {
                speedChart.data.labels = [];
                speedChart.data.datasets[0].data = [];
                speedChart.update('none');
            }
            
            // –°–±—Ä–æ—Å –≥—Ä–∞—Ñ–∏–∫–æ–≤ –≤—ã—Å–æ—Ç—ã –∏ —É–∫–ª–æ–Ω–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç—ã–µ)
            if (elevationChart && elevationChart.data.datasets[0].fullData) {
                elevationChart.data.datasets[0].data = [];
                elevationChart.update('none');
            }
            
            if (gradientChart && gradientChart.data.datasets[0].fullData) {
                gradientChart.data.datasets[0].data = [];
                gradientChart.update('none');
            }
            
            // –°–±—Ä–æ—Å UI
            document.getElementById('currentSpeed').textContent = '0 –∫–º/—á';
            document.getElementById('travelTime').textContent = '0:00';
            document.getElementById('distanceTraveled').textContent = '0.0 –∫–º';
            document.getElementById('currentConsumption').textContent = '0.0 –ª/100–∫–º';
            document.getElementById('optimalSpeed').textContent = '- –∫–º/—á';
            document.getElementById('speedReason').textContent = '-';
            
            document.getElementById('playBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏–º—É–ª—è—Ü–∏–∏ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 100–º—Å)
        function updateSimulation() {
            if (!isSimulationRunning || currentPointIndex >= routePoints.length - 1) {
                if (currentPointIndex >= routePoints.length - 1) {
                    pauseSimulation();
                    showStatus('–ú–∞—Ä—à—Ä—É—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!', 'success');
                }
                return;
            }
            
            const currentPoint = routePoints[currentPointIndex];
            const gradient = currentPoint.gradient || 0;
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ —É–∫–ª–æ–Ω–∞
            let targetSpeed = 60; // –ë–∞–∑–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å
            const maxSpeed = vehicleData?.vehicle.max_speed_kmh || 90;
            
            if (gradient > 5) {
                targetSpeed = Math.max(30, maxSpeed - (gradient - 5) * 5);
            } else if (gradient < -5) {
                targetSpeed = Math.max(40, maxSpeed - Math.abs(gradient + 5) * 3);
            } else if (gradient > 2) {
                targetSpeed = maxSpeed * 0.8;
            } else if (gradient < -2) {
                targetSpeed = maxSpeed * 0.85;
            } else {
                targetSpeed = maxSpeed * 0.7; // –ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å
            }
            
            // –ü–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
            const acceleration = vehicleData?.simulation.acceleration_kmh_per_sec || 5.0;
            const deceleration = vehicleData?.simulation.deceleration_kmh_per_sec || 8.0;
            
            if (currentSpeed < targetSpeed) {
                currentSpeed = Math.min(targetSpeed, currentSpeed + acceleration * 0.1);
            } else if (currentSpeed > targetSpeed) {
                currentSpeed = Math.max(targetSpeed, currentSpeed - deceleration * 0.1);
            }
            
            // –†–∞—Å—á–µ—Ç –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–≥–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –∑–∞ 0.1 —Å–µ–∫—É–Ω–¥—ã (—Å —É—á–µ—Ç–æ–º –º–Ω–æ–∂–∏—Ç–µ–ª—è)
            const distancePerUpdate = (currentSpeed / 3600) * 0.1 * timeMultiplier; // –∫–º
            const distancePerUpdateMeters = distancePerUpdate * 1000; // –º–µ—Ç—Ä—ã
            
            // –ù–∞—Ö–æ–¥–∏–º —Å–ª–µ–¥—É—é—â—É—é —Ç–æ—á–∫—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–≥–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
            let targetDistance = (currentPoint.dist_m || 0) + distancePerUpdateMeters;
            let nextIndex = currentPointIndex;
            
            // –ò—â–µ–º —Ç–æ—á–∫—É —Å –Ω—É–∂–Ω—ã–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ–º
            while (nextIndex < routePoints.length - 1 && 
                   (routePoints[nextIndex].dist_m || 0) < targetDistance) {
                nextIndex++;
            }
            
            currentPointIndex = nextIndex;
            
            if (currentPointIndex >= routePoints.length) {
                currentPointIndex = routePoints.length - 1;
            }
            
            const newPoint = routePoints[currentPointIndex];
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –º–∞—Ä–∫–µ—Ä–∞
            vehicleMarker.setLatLng([newPoint.lat, newPoint.lon]);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–π–¥–µ–Ω–Ω—ã–π –ø—É—Ç—å (–∫–∞–∂–¥—ã–µ 10 —Ç–æ—á–µ–∫ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
            if (currentPointIndex % 10 === 0) {
                traveledPath.addLatLng([newPoint.lat, newPoint.lon]);
            }
            
            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –¢–°
            map.panTo([newPoint.lat, newPoint.lon]);
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
            const distanceKm = (newPoint.dist_m || 0) / 1000;
            
            // –í—Ä–µ–º—è –≤ –ø—É—Ç–∏ (–í–ò–†–¢–£–ê–õ–¨–ù–û–ï –≤—Ä–µ–º—è —Å —É—á–µ—Ç–æ–º –º–Ω–æ–∂–∏—Ç–µ–ª—è)
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—à–ª–æ –±—ã –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏
            const virtualTimeSeconds = distanceKm / currentSpeed * 3600; // —Å–µ–∫—É–Ω–¥—ã
            const virtualHours = Math.floor(virtualTimeSeconds / 3600);
            const virtualMinutes = Math.floor((virtualTimeSeconds % 3600) / 60);
            const virtualSeconds = Math.floor(virtualTimeSeconds % 60);
            
            let timeString;
            if (virtualHours > 0) {
                timeString = `${virtualHours}:${virtualMinutes.toString().padStart(2, '0')}:${virtualSeconds.toString().padStart(2, '0')}`;
            } else {
                timeString = `${virtualMinutes}:${virtualSeconds.toString().padStart(2, '0')}`;
            }
            
            // –†–∞—Å—Ö–æ–¥ (–ò–°–ü–†–ê–í–õ–ï–ù–û: —Ç–µ–ø–µ—Ä—å —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ)
            const consumption = calculateCurrentConsumption(currentSpeed, gradient);
            
            // –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å
            const optimal = calculateOptimalSpeed(gradient, currentSpeed);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ (–ù–ê–ö–û–ü–ò–¢–ï–õ–¨–ù–û)
            // –ì—Ä–∞—Ñ–∏–∫ —Å–∫–æ—Ä–æ—Å—Ç–∏
            speedHistory.push(currentSpeed);
            if (speedHistory.length > 100) {
                speedHistory.shift();
            }
            speedChart.data.labels = speedHistory.map((_, i) => '');
            speedChart.data.datasets[0].data = speedHistory;
            speedChart.update('none');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ –≤—ã—Å–æ—Ç—ã –∏ —É–∫–ª–æ–Ω–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–π–¥–µ–Ω–Ω—ã–π —É—á–∞—Å—Ç–æ–∫)
            if (elevationChart.data.datasets[0].fullData && gradientChart.data.datasets[0].fullData) {
                const progressPercent = currentPointIndex / routePoints.length;
                const totalChartPoints = elevationChart.data.datasets[0].fullData.length;
                const chartPointsToShow = Math.floor(totalChartPoints * progressPercent);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–æ–π–¥–µ–Ω–Ω—É—é —á–∞—Å—Ç—å
                elevationChart.data.datasets[0].data = 
                    elevationChart.data.datasets[0].fullData.slice(0, chartPointsToShow);
                elevationChart.update('none');
                
                gradientChart.data.datasets[0].data = 
                    gradientChart.data.datasets[0].fullData.slice(0, chartPointsToShow);
                gradientChart.update('none');
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.getElementById('currentSpeed').textContent = currentSpeed.toFixed(0) + ' –∫–º/—á';
            document.getElementById('travelTime').textContent = timeString;
            document.getElementById('distanceTraveled').textContent = distanceKm.toFixed(1) + ' –∫–º';
            document.getElementById('currentConsumption').textContent = consumption.toFixed(1) + ' –ª/100–∫–º';
            document.getElementById('optimalSpeed').textContent = optimal.speed + ' –∫–º/—á';
            document.getElementById('speedReason').textContent = optimal.reason;
        }
        
        // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
        function loadTestRoute() {
            document.getElementById('startAddress').value = '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥';
            document.getElementById('endAddress').value = '–ú–æ—Å–∫–≤–∞';
            document.getElementById('nPoints').value = '10000';  // –ú–µ–Ω—å—à–µ –¥–ª—è —Ç–µ—Å—Ç–∞
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', function() {
            loadVehicleData();
            initCharts();
        });
        
        // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ)
        // loadTestRoute();
    </script>
</body>
</html>
